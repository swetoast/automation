{% set timeofday = states('sensor.timeofday') | capitalize %}
{% set weather_condition = states('weather.forecast_home') %}
{% set forecast = state_attr('weather.forecast_home', 'forecast') %}
{% set season = states('sensor.season') %}
{% set thunder_probability = state_attr('weather.smhi_home', 'thunder_probability') %}
{% set frost_risk = states('sensor.thermal_comfort_frost_risk') != 'no_risk' %}
{% set uv_index = states('sensor.uv_sensor') | float %}
{% set sweden_calendar = states('calendar.sweden') == 'on' %}
{% set aurora_57_12 = states('binary_sensor.aurora_57_12') == 'on' %}
{% set pollen_types = ['Alder', 'Birch', 'Grasses', 'Mugwort', 'Olive Tree', 'Ragweed'] %}
{% set pollen_levels = {(4, 8): 'medium', (8, float('inf')): 'high'} %}
{% set pm25 = states('sensor.sensor_47571_pm2_5') | int %}
{% set lightning_counter = states('sensor.blitzortung_lightning_counter') %}
{% set lightning_distance = states('sensor.blitzortung_lightning_distance') %}
{% set lightning_azimuth = states('sensor.blitzortung_lightning_azimuth') %}

{% set ns = namespace(temp_sum=0, humidity_sum=0, wind_speed_sum=0, wind_bearing_sum=0, low_temp_sum=0, gust_speed_sum=0, precipitation_sum=0, condition='', precipitation_probability=0) %}
{% for i in range(0, 3) %}
    {% if forecast is defined and forecast[i] is defined %}
        {% set ns.temp_sum = ns.temp_sum + forecast[i]['temperature']|float %}
        {% set ns.humidity_sum = ns.humidity_sum + forecast[i]['humidity']|float %}
        {% set ns.wind_speed_sum = ns.wind_speed_sum + forecast[i]['wind_speed']|float %}
        {% set ns.wind_bearing_sum = ns.wind_bearing_sum + forecast[i]['wind_bearing']|float %}
        {% set ns.low_temp_sum = ns.low_temp_sum + forecast[i]['templow']|float %}
        {% set ns.gust_speed_sum = ns.gust_speed_sum + forecast[i]['wind_gust_speed']|float %}
        {% set ns.precipitation_sum = ns.precipitation_sum + forecast[i]['precipitation']|float %}
        {% set ns.condition = forecast[i]['condition'] %}
        {% set ns.precipitation_probability = ns.precipitation_probability + forecast[i]['precipitation_probability']|float %}
    {% endif %}
{% endfor %}
{% set median_temp = (ns.temp_sum / 3)|round(1) %}
{% set median_humidity = (ns.humidity_sum / 3)|round(1) %}
{% set median_wind_speed = (ns.wind_speed_sum / 3)|round(1) %}
{% set median_wind_bearing = (ns.wind_bearing_sum / 3)|round(1) %}
{% set median_low_temp = (ns.low_temp_sum / 3)|round(1) %}
{% set median_gust_speed = (ns.gust_speed_sum / 3)|round(1) %}
{% set median_precipitation = (ns.precipitation_sum / 3)|round(1) %}
{% set condition = ns.condition %}
{% set median_precipitation_probability = (ns.precipitation_probability / 3)|round(1) %}
{% set frost_risk_level = states('sensor.thermal_comfort_frost_risk') | replace('_', ' ') if frost_risk else '' %}
{% set sweden_calendar_message = states.calendar.sweden.attributes.message if sweden_calendar else '' %}
{% set aurora_57_12_chance = states('sensor.aurora_57_12') if aurora_57_12 else '' %}
{% set pm25_status = 'hazardous' if pm25 > 250.4 else 'very unhealthy' if pm25 > 150.4 else 'unhealthy' if pm25 > 55.4 else 'unhealthy for sensitive groups' if pm25 > 35.4 else 'moderate' if pm25 > 12 else 'good' %}

Good {{timeofday}}!
{% if sweden_calendar %}
    Did you know that today is {{sweden_calendar_message}}?
{% endif %}
Today,
{% if season == 'spring' %}
    as spring is in the air,
{% elif season == 'summer' %}
    in the heart of summer,
{% elif season == 'autumn' %}
    with autumn leaves falling,
{% elif season == 'winter' %}
    in the midst of winter,
{% endif %}
we're expecting a {{ condition }} day with temperatures reaching up to {{ median_temp }}Â°C. The humidity will be around {{ median_humidity }}%. The wind speed will be around {{ median_wind_speed }} km/h.

{% if uv_index < 3 %}
    The UV Index is low today.
{% elif uv_index < 6 %}
    The UV Index is moderate today.
{% elif uv_index < 8 %}
    The UV Index is high today.
{% elif uv_index < 11 %}
    The UV Index is very high today. Please take extra precautions if you need to be outdoors.
{% else %}
    The UV Index is extreme today. Please take extra precautions if you need to be outdoors.
{% endif %}

{% if thunder_probability is not none and thunder_probability | int > 33 %}
    Also, there's a thunder probability of {{ thunder_probability }}%.
{% endif %}

{% if lightning_counter is not none and lightning_counter | int > 1 %}
    In fact, there have been {{ lightning_counter }} lightning strikes detected. The most recent one was detected at a distance of {{ lightning_distance }} and an in the direction of {{ lightning_azimuth }} degrees.
{% endif %}

{% if frost_risk %}
    And watch out for the frost, there's a {{frost_risk_level}} risk.
{% endif %}

{% for pollen in pollen_types %}
    {% set level = state_attr('sensor.pollen_data', pollen)|float %}
    {% for range, descriptor in pollen_levels.items() %}
        {% if level >= range[0] and level < range[1] %}
            For those with allergies, please note that the {{pollen | lower}} pollen levels are {{descriptor}} today.
        {% endif %}
    {% endfor %}
{% endfor %}

{% if aurora_57_12 %}
    And the cherry on top? There's a {{aurora_57_12_chance}}% chance of seeing the stunning aurora tonight.
{% endif %}

{% if pm25_status %}
    And the air quality is {{pm25_status}} outside.
{% endif %}

Have a great day!
